import struct
import glob
import socket # imports Pythonâ€™s built-in socket library, for communication between computers over a network
import os # import operations from system
from protocol import *



SERVER_HOST = '127.0.0.1' # IP address of server
SERVER_PORT = 5001 # port that client needs connect to
BUFFER_SIZE = 4096 # size of the file in bytes (every chunk)
FILE_PATH = '_01_NETWORKS.pdf' # specify the path of the file to send
DISCONNECT_MSG: str = "EXIT"
FORMAT: str = 'utf-8'


def __init__(self, host: str, port: int):
    self._client_socket = None
    self._host = host
    self._port = port


def connect(self) -> socket:
    try:
        self._client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self._client_socket.connect((self._host, self._port))
        protocol.write_to_log(f"[CLIENT_BL] {self._client_socket.getsockname()} connected")
        return self._client_socket
    except Exception as e:
        protocol.write_to_log("[CLIENT_BL] Exception on connect: {}".format(e))
        return None


def disconnect(self) -> bool:
    try:
        write_to_log(f"[CLIENT_BL] {self._client_socket.getsockname()} closing")
        self.send_data(DISCONNECT_MSG)
        self._client_socket.close()
        return True
    except Exception as e:
        write_to_log("[CLIENT_BL] Exception on disconnect: {}".format(e))
        return False


def send_data(self, cmd: str, args: str = '') -> bool:
    try:
        args2 = f"{args}"
        request = create_request_msg(cmd, args2)
        self._client_socket.send(request.encode(FORMAT))
        write_to_log(f"[CLIENT_BL] send {self._client_socket.getsockname()} {cmd} ")
        return True
    except Exception as e:
        write_to_log("[CLIENT_BL] Exception on send_data: {}".format(e))
        return False


def receive_data(self) -> str:
    try:
        (bres, msg) = receive_msg(self._client_socket)
        if bres:
            # message = msg.decode(FORMAT)
            write_to_log(f"[CLIENT_BL] received {self._client_socket.getsockname()} {msg} ")
            return msg
        else:
            write_to_log("[CLIENT_BL] Invalid msg")
            return "Invalid msg"
    except Exception as e:
        write_to_log("[CLIENT_BL] Exception on receive: {}".format(e))
        return ""
    

# code for sending client's data
def send_protocol_msg(sock, text):
    msg = f"{len(text):>2}{text}"
    sock.send(msg.encode())

def recv_protocol_msg(sock):
    header = sock.recv(2).decode()
    length = int(header)
    return sock.recv(length).decode()
    
    

def main():
    folder_name = input("Enter name of image set: ")

    # gather images to send
    images = glob.glob(f"{"images_to_send"}/*.jpg")
    img_count = len(images)

    if img_count == 0:
        print("No images found to send.")
        return

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((SERVER_HOST, SERVER_PORT))

    # send request
    request = f"REQUEST_IMAGES|{folder_name}|{img_count}"
    send_protocol_msg(sock, request)

    # send images
    for img in images:
        print(f"Sending: {img}")
        protocol.send_image(sock, img)

    # wait for confirmation
    response = recv_protocol_msg(sock)
    print("Server:", response)

    sock.close()
